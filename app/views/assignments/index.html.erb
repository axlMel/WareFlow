<div class="min-h-screen flex flex-col lg:flex-row gap-6 p-4 lg:p-6">
  <!-- Sidebar de filtros -->
  <div class="w-full lg:w-1/4 space-y-4">
    <div class="bg-white p-4 rounded-2xl shadow space-y-4">
      <h1 class="text-2xl font-bold text-gray-800">Asignaciones</h1>

      <%= form_with url: deliveries_path, method: :get, local: true do |form| %>
        <div class="space-y-4">
          <!-- Cliente -->
          <div>
            <%= form.label :client, "Cliente", class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_field :client, class: "w-full border border-gray-300 rounded-lg px-3 py-2" %>
          </div>

          <!-- Folio -->
          <div>
            <%= form.label :folio, "Folio", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :folio, class: "w-full border border-gray-300 rounded-lg px-3 py-2" %>
          </div>

          <!-- Usuario -->
          <div>
            <%= form.label :user_id, "Usuario", class: "block text-sm font-medium text-gray-700" %>
            <%= form.collection_select :user_id, @users, :id, :username, {}, class: "w-full border border-gray-300 rounded-lg px-3 py-2" %>
          </div>

          <!-- Estado -->
          <div>
            <%= form.label :status, "Estado", class: "block text-sm font-medium text-gray-700" %>
            <%= form.select :status, [['Creado', false], ['Asignado', true]], {}, class: "w-full border border-gray-300 rounded-lg px-3 py-2" %>
          </div>

          <div class="pt-2">
            <%= form.submit 'Filtrar', class: "w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-xl hover:bg-indigo-700 transition" %>
          </div>
        </div>
      <% end %>

      <div class="pt-4 flex justify-center">
        <%= link_to "Nueva Asignación", new_assignment_path, data: { turbo_frame: "modal" }, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-sm font-medium shadow" %>
      </div>
    </div>
  </div>

  <!-- Panel principal -->
  <div class="w-full lg:w-3/4 space-y-4">
    <div class="bg-white p-4 rounded-2xl shadow">
      <h2 class="text-xl font-semibold mb-4">Historial de Asignaciones</h2>

      <div class="space-y-6">
        <% @assignments.group_by { |a| a.delivery.folio_id }.each do |folio_id, grouped_assignments| %>
          <div class="bg-gray-50 rounded-xl shadow border">
            <!-- Cabecera de grupo -->
            <div class="flex items-center justify-between px-6 py-3 bg-indigo-100 rounded-t-xl">
              <div>
                <p class="font-semibold text-indigo-800">Folio #<%= folio_id %></p>
                <% delivery = grouped_assignments.first.delivery %>
                <p class="text-sm text-gray-600">
                  Cliente: <%= delivery.client %> |
                  Usuario: <%= delivery.user&.username || "N/A" %> |
                  Fecha: <%= delivery.created_at.strftime("%d/%m/%Y") %>
                </p>
              </div>
              <%= link_to "Ver entrega", delivery_path(grouped_assignments.first.delivery), class: "text-indigo-600 hover:underline text-sm" %>
            </div>

            <!-- Tabla interna -->
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm text-left border-collapse">
                <thead class="text-xs text-gray-500 uppercase border-b">
                  <tr>
                    <th class="px-6 py-3 text-left w-48">Producto</th>
                    <th class="px-6 py-3 text-left w-24">Cantidad</th>
                    <th class="px-6 py-3 text-left w-32">Estado</th>
                    <th class="px-6 py-3 text-left w-40">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <% grouped_assignments.each do |a| %>
                    <tr class="border-t hover:bg-gray-50">
                      <td class="px-6 py-4 w-48"><%= a.product&.title || "N/A" %></td>
                      <td class="px-6 py-4 w-24"><%= a.quantity %></td>
                      <td class="px-6 py-4 w-32">
                        <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold
                          <%= a.installed? ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
                          <%= a.status.titleize %>
                        </span>
                      </td>
                      <td class="px-6 py-4 space-x-2 whitespace-nowrap w-40">
                        <%= link_to "Ver", assignment_path(a), class: "text-blue-600 hover:underline text-sm", data: { turbo_frame: "modal" } %>
                        <%= link_to "Editar", edit_assignment_path(a), class: "text-yellow-600 hover:underline text-sm", data: { turbo_frame: "modal" } %>
                        <%= link_to "Eliminar", assignment_path(a),
                              method: :delete,
                              data: { confirm: "¿Estás seguro?" },
                              class: "text-red-600 hover:underline text-sm" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>